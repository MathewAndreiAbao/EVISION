import{d as Ut,a as D,c as Xt,f as N,s as y,b as dt}from"../chunks/BGsM1btW.js";import{p as Yt,d as f,f as k,o as Zt,j as te,h as nt,t as U,a as ee,e as ae,b as c,g as t,i as ct,s,$ as re,c as a,r as e,n as vt}from"../chunks/DEPQPQt8.js";import{i as Wt}from"../chunks/CVvYbTkW.js";import{e as pt,i as mt}from"../chunks/DFPLsyL_.js";import{t as j,f as V,a as se}from"../chunks/tw1RdNRP.js";import{h as oe,s as z,r as ie,a as le}from"../chunks/BFGHZJqN.js";import{b as de}from"../chunks/CEtDmXYx.js";import{a as ne,s as ce}from"../chunks/DNJl1ib1.js";import{p as ve}from"../chunks/CSn65FV0.js";import{S as X,C as pe}from"../chunks/BZZLp1oO.js";import{S as me}from"../chunks/81uDzRXJ.js";import{C as ue}from"../chunks/m6Yt8xyM.js";import{D as fe}from"../chunks/DuGwofyl.js";import{getWeekNumber as ut,calculateCompliance as Y,getSubmissionWeek as ft,groupSubmissionsByWeek as ge,getComplianceBgClass as xe,getComplianceClass as _e}from"../chunks/DmYj-g2y.js";var be=N('<div class="glass-card-static p-8 animate-pulse text-center"><div class="h-4 bg-gray-200 rounded w-24 mx-auto mb-4"></div> <div class="h-10 bg-gray-200 rounded w-16 mx-auto"></div></div>'),he=N('<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6"></div>'),ye=N('<tr class="hover:bg-white/40 transition-colors cursor-pointer"><td class="px-6 py-4 font-medium text-text-primary"> </td><td class="px-4 py-4 text-center text-gov-green font-semibold"> </td><td class="px-4 py-4 text-center text-gov-gold-dark font-semibold"> </td><td class="px-4 py-4 text-center text-gov-red font-semibold"> </td><td class="px-4 py-4 text-center"><span> </span></td><td class="px-6 py-4 text-right"><button class="text-gov-blue hover:underline font-semibold text-xs">Details</button></td></tr>'),we=N('<div class="grid grid-cols-2 lg:grid-cols-4 gap-6"><div><!></div> <div><!></div> <div><!></div> <div><!></div></div> <div class="grid grid-cols-1 xl:grid-cols-2 gap-6"><div class="glass-card-static p-6"><h3 class="text-lg font-bold text-text-primary mb-4">School Performance Heatmap</h3> <!></div> <div class="glass-card-static p-6"><h3 class="text-lg font-bold text-text-primary mb-4">District-Wide Trend</h3> <div class="h-[280px]"><!></div></div></div> <div class="glass-card-static overflow-hidden"><div class="px-6 py-4 border-b border-gray-100 flex items-center justify-between flex-wrap gap-4"><h3 class="text-lg font-bold text-text-primary">School Rankings</h3> <input type="text" placeholder="Search school..." class="px-4 py-2 text-sm bg-white/60 border border-gray-200 rounded-xl outline-none focus:ring-2 focus:ring-gov-blue/30 w-64"/></div> <div class="overflow-x-auto"><table class="w-full text-sm"><thead><tr class="bg-gray-50/50 text-left border-b border-gray-100"><th class="px-6 py-3 font-semibold text-text-muted cursor-pointer hover:text-text-primary">School</th><th class="px-4 py-3 text-center font-semibold text-text-muted">Compliant</th><th class="px-4 py-3 text-center font-semibold text-text-muted">Late</th><th class="px-4 py-3 text-center font-semibold text-text-muted">Missing</th><th class="px-4 py-3 text-center font-semibold text-text-muted cursor-pointer hover:text-text-primary">Rate</th><th class="px-6 py-3 text-right font-semibold text-text-muted">Action</th></tr></thead><tbody class="divide-y divide-gray-50"></tbody></table></div></div>',1),ke=N('<div class="py-3 flex items-center justify-between"><div class="min-w-0 pr-4"><p class="text-sm font-medium text-text-primary truncate"> </p> <p class="text-xs text-text-muted"> </p></div> <!></div>'),Ce=N('<div class="space-y-4"><div class="grid grid-cols-3 gap-3"><div class="bg-gov-blue/5 p-3 rounded-lg text-center"><p class="text-xs text-text-muted mb-1">Expectation</p> <p class="text-lg font-bold text-gov-blue"> </p></div> <div class="bg-gov-green/5 p-3 rounded-lg text-center"><p class="text-xs text-text-muted mb-1">Compliance</p> <p class="text-lg font-bold text-gov-green"> </p></div> <div class="bg-gov-red/5 p-3 rounded-lg text-center"><p class="text-xs text-text-muted mb-1">Missing</p> <p class="text-lg font-bold text-gov-red"> </p></div></div> <div class="divide-y divide-gray-100"></div></div>'),Se=N('<div class="space-y-10"><div class="flex flex-col md:flex-row md:items-end justify-between gap-4"><div><h1 class="text-3xl font-black text-text-primary tracking-tight">District Oversight</h1> <p class="text-base text-text-secondary mt-1 font-medium">Monitoring performance across <span class="font-bold text-gov-blue"> </span> in the district</p></div></div> <!></div> <!>',1);function Oe(Lt,Mt){Yt(Mt,!0);const jt=()=>ce(ve,"$profile",Nt),[Nt,qt]=ne();let C=f(k([])),q=f(k([])),gt=f(!0),B=f(k({totalSchools:0,overallRate:0,lateCount:0,atRiskCount:0,previousRate:0})),xt=f(k([])),_t=f(k([])),bt=f(k([])),ht=f(k([])),yt=f(k([])),F=f("rate"),E=f("desc"),Q=f(""),Z=f(!1),A=f(null),wt=f(k([])),tt=null;Zt(async()=>{await kt(),c(gt,!1),tt=z.channel("district-monitoring").on("postgres_changes",{event:"*",schema:"public",table:"submissions"},()=>kt()).subscribe()}),te(()=>{tt&&z.removeChannel(tt)});async function kt(){const o=jt();if(!o?.district_id)return;const{data:l}=await z.from("schools").select("id, name, district_id").eq("district_id",o.district_id).order("name");if(!l)return;const v=l.map(r=>r.id),{data:d}=await z.from("submissions").select(`
                id, user_id, file_name, doc_type, compliance_status, created_at, week_number,
                profiles!inner(school_id)
            `).in("profiles.school_id",v).order("created_at",{ascending:!1}),{data:m}=await z.from("teaching_loads").select("id, profiles!inner(school_id)").in("profiles.school_id",v),{data:i}=await z.from("academic_calendar").select("*").eq("school_year","2025-2026").order("week_number",{ascending:!0}),u=(i||[]).filter(r=>r.district_id===o.district_id||!r.district_id);c(C,l.map(r=>{const h=(d||[]).filter(p=>(Array.isArray(p.profiles)?p.profiles[0]:p.profiles)?.school_id===r.id),$=(m||[]).filter(p=>(Array.isArray(p.profiles)?p.profiles[0]:p.profiles)?.school_id===r.id).length,H=ut();u.find(p=>p.week_number===H);const W=Y(h,$);return{...r,...W,loadCount:$}}),!0),c(q,(d||[]).map(r=>{const h=Array.isArray(r.profiles)?r.profiles[0]:r.profiles;return{...r,school_id:h?.school_id,week_number:ft(r)}}),!0);const n=t(C).reduce((r,h)=>r+(h.loadCount||0),0),b=ut();u.find(r=>r.week_number===b);const g=Y(t(q),n);u.find(r=>r.week_number===b-1);const S=t(q).filter(r=>ft(r)===b-1),R=Y(S,n);c(B,{totalSchools:t(C).length,overallRate:g.rate,lateCount:g.Late,atRiskCount:t(C).filter(r=>(r.rate||0)<70).length,previousRate:R.rate},!0),Bt(u);const _=ge(t(q),n,8,u);c(ht,_.map(r=>r.label),!0),c(yt,[{label:"District Compliance",data:_.map(r=>r.rate),color:"#0038A8"},{label:"80% Target",data:_.map(()=>80),color:"#CE1126",dashed:!0}],!0)}function Bt(o){ut();const v=[],d=[...o].sort((i,u)=>u.week_number-i.week_number).slice(0,8).reverse();for(const i of d)v.push({week:i.week_number,label:`W${i.week_number}`,deadline:i.deadline_date});c(_t,v,!0),c(xt,t(C).map(i=>i.name),!0);const m=[];for(const i of t(C)){const u=t(q).filter(n=>n.school_id===i.id);for(const n of v){const b=u.filter(S=>ft(S)===n.week),g=Y(b,i.loadCount,i.loadCount,n.deadline);m.push({row:i.name,week:n.week,rate:g.rate,tooltip:`${i.name} — ${n.label}: ${g.rate}%`})}}c(bt,m,!0)}const Et=ct(()=>()=>{let o=[...t(C)];if(t(Q).trim()){const l=t(Q).toLowerCase();o=o.filter(v=>v.name.toLowerCase().includes(l))}return o.sort((l,v)=>{const d=l[t(F)],m=v[t(F)];return typeof d=="number"?t(E)==="asc"?d-m:m-d:t(E)==="asc"?String(d).localeCompare(String(m)):String(m).localeCompare(String(d))}),o});function Ct(o){c(A,o,!0),c(wt,t(q).filter(l=>l.school_id===o.id).slice(0,50),!0),c(Z,!0)}var St=Se();oe("1thoarh",o=>{ae(()=>{re.title="District Monitoring — Smart E-VISION"})});var et=nt(St),at=a(et),$t=a(at),Dt=s(a($t),2),At=s(a(Dt)),Ht=a(At);e(At),vt(),e(Dt),e($t),e(at);var It=s(at,2);{var Ot=o=>{var l=he();pt(l,20,()=>Array(4),mt,(v,d)=>{var m=be();D(v,m)}),e(l),D(o,l)},Pt=o=>{var l=we(),v=nt(l),d=a(v),m=a(d);X(m,{icon:"School",get value(){return t(B).totalSchools},label:"Active Schools"}),e(d);var i=s(d,2),u=a(i);X(u,{icon:"Activity",get value(){return`${t(B).overallRate??""}%`},label:"District Rate",color:"from-gov-green to-gov-green-dark"}),e(i);var n=s(i,2),b=a(n);X(b,{icon:"Clock",get value(){return t(B).lateCount},label:"Late Submissions",color:"from-gov-gold to-gov-gold-dark"}),e(n);var g=s(n,2),S=a(g);X(S,{icon:"ShieldAlert",get value(){return t(B).atRiskCount},label:"Alert Schools",color:"from-gov-red to-red-700"}),e(g),e(v);var R=s(v,2),_=a(R),r=s(a(_),2);ue(r,{get rows(){return t(xt)},get weeks(){return t(_t)},get cells(){return t(bt)},onCellClick:M=>{const x=t(C).find(T=>T.name===M);x&&Ct(x)}}),e(_);var h=s(_,2),$=s(a(h),2),H=a($);pe(H,{get labels(){return t(ht)},get datasets(){return t(yt)},height:280}),e($),e(h),e(R);var W=s(R,2),p=a(W),I=s(a(p),2);ie(I),e(p);var w=s(p,2),O=a(w),L=a(O),P=a(L),G=a(P),J=s(G,4);vt(),e(P),e(L);var K=s(L);pt(K,21,()=>t(Et)(),mt,(M,x)=>{var T=ye(),rt=a(T),Vt=a(rt,!0);e(rt);var st=s(rt),zt=a(st,!0);e(st);var ot=s(st),Ft=a(ot,!0);e(ot);var it=s(ot),Qt=a(it,!0);e(it);var Rt=s(it),lt=a(Rt),Gt=a(lt);e(lt),e(Rt),vt(),e(T),U((Jt,Kt)=>{y(Vt,t(x).name),y(zt,t(x).Compliant),y(Ft,t(x).Late),y(Qt,t(x).NonCompliant),le(lt,1,`px-2.5 py-1 rounded-full text-xs font-bold ${Jt??""} ${Kt??""}`),y(Gt,`${t(x).rate??""}%`)},[()=>xe(t(x).rate||0),()=>_e(t(x).rate||0)]),dt("click",T,()=>Ct(t(x))),D(M,T)}),e(K),e(O),e(w),e(W),j(1,d,()=>V,()=>({y:20,duration:400})),j(1,i,()=>V,()=>({y:20,duration:400,delay:100})),j(1,n,()=>V,()=>({y:20,duration:400,delay:200})),j(1,g,()=>V,()=>({y:20,duration:400,delay:300})),j(1,_,()=>V,()=>({y:20,duration:500,delay:400})),j(1,h,()=>V,()=>({y:20,duration:500,delay:500})),de(I,()=>t(Q),M=>c(Q,M)),dt("click",G,()=>{c(F,"name"),c(E,t(E)==="asc"?"desc":"asc",!0)}),dt("click",J,()=>{c(F,"rate"),c(E,t(E)==="asc"?"desc":"asc",!0)}),j(1,W,()=>se,()=>({duration:500,delay:600})),D(o,l)};Wt(It,o=>{t(gt)?o(Ot):o(Pt,!1)})}e(et);var Tt=s(et,2);{let o=ct(()=>t(A)?`School Submissions: ${t(A).name}`:"School Details");fe(Tt,{get isOpen(){return t(Z)},get title(){return t(o)},onClose:()=>c(Z,!1),children:(l,v)=>{var d=Xt(),m=nt(d);{var i=u=>{var n=Ce(),b=a(n),g=a(b),S=s(a(g),2),R=a(S,!0);e(S),e(g);var _=s(g,2),r=s(a(_),2),h=a(r);e(r),e(_);var $=s(_,2),H=s(a($),2),W=a(H,!0);e(H),e($),e(b);var p=s(b,2);pt(p,21,()=>t(wt),mt,(I,w)=>{var O=ke(),L=a(O),P=a(L),G=a(P,!0);e(P);var J=s(P,2),K=a(J);e(J),e(L);var M=s(L,2);{let x=ct(()=>t(w).compliance_status==="late"?"late":t(w).compliance_status==="non-compliant"||t(w).compliance_status==="missing"?"non-compliant":"compliant");me(M,{get status(){return t(x)},size:"sm"})}e(O),U(()=>{y(G,t(w).file_name),y(K,`${t(w).doc_type??""} • Week ${t(w).week_number??""}`)}),D(I,O)}),e(p),e(n),U(()=>{y(R,t(A).loadCount),y(h,`${t(A).rate??""}%`),y(W,t(A).NonCompliant)}),D(u,n)};Wt(m,u=>{t(A)&&u(i)})}D(l,d)},$$slots:{default:!0}})}U(()=>y(Ht,`${t(B).totalSchools??""} schools`)),D(Lt,St),ee(),qt()}Ut(["click"]);export{Oe as component};
