import{w as C}from"./DEPQPQt8.js";import{s as d}from"./BFGHZJqN.js";import{a as y}from"./D9J-t_xT.js";function u(e){return new Promise((n,i)=>{e.oncomplete=e.onsuccess=()=>n(e.result),e.onabort=e.onerror=()=>i(e.error)})}function L(e,n){let i;const a=()=>{if(i)return i;const s=indexedDB.open(e);return s.onupgradeneeded=()=>s.result.createObjectStore(n),i=u(s),i.then(l=>{l.onclose=()=>i=void 0},()=>{}),i};return(s,l)=>a().then(r=>l(r.transaction(n,s).objectStore(n)))}let b;function w(){return b||(b=L("keyval-store","keyval")),b}function K(e,n=w()){return n("readonly",i=>u(i.get(e)))}function N(e,n,i=w()){return i("readwrite",a=>(a.put(n,e),u(a.transaction)))}function k(e,n=w()){return n("readwrite",i=>(i.delete(e),u(i.transaction)))}function T(e,n){return e.openCursor().onsuccess=function(){this.result&&(n(this.result),this.result.continue())},u(e.transaction)}function I(e=w()){return e("readonly",n=>{if(n.getAllKeys)return u(n.getAllKeys());const i=[];return T(n,a=>i.push(a.key)).then(()=>i)})}const A=C(0),v="sync_queue_";async function H(e){const n=`${v}${e.timestamp}_${e.fileHash.slice(0,8)}`;await N(n,e),await D()}async function F(){return(await I()).filter(n=>String(n).startsWith(v)).length}async function D(){const e=await F();A.set(e)}let S=!1;async function E(){if(typeof navigator<"u"&&!navigator.onLine)return!1;try{const e=new AbortController,n=setTimeout(()=>e.abort(),5e3),i=await fetch(window.location.origin,{method:"HEAD",cache:"no-store",signal:e.signal});return clearTimeout(n),i.ok||i.status===405}catch(e){return console.warn("[offline] Connection check failed:",e),!1}}async function p(e=!1){if(!(e?!0:await E()))return{success:0,failed:0};if(S&&!e)return console.log("[offline] processQueue skipped: Already syncing"),{success:0,failed:0};const a=(await I()).filter(r=>String(r).startsWith(v));if(a.length===0)return{success:0,failed:0};console.log(`[offline] Found ${a.length} items to sync...`),S=!0;let s=0,l=0;y("info",`Syncing ${a.length} offline file(s)...`);try{for(const r of a){if(!e&&!await E()){console.log("[offline] Connection lost during sync. Pausing...");break}const t=await K(r);if(!t){console.warn(`[offline] Found ghost key ${r}, removing...`),await k(r);continue}try{const{data:g}=await d.from("submissions").select("id").eq("file_hash",t.fileHash).maybeSingle();if(g){console.warn(`[offline] Skipping duplicate file: ${t.fileName}`),await k(r),y("warning",`Skipped duplicate: ${t.fileName}`);continue}const{error:$}=await d.storage.from("submissions").upload(t.filePath,t.pdfBytes,{contentType:"application/pdf",upsert:!1});if($)throw new Error(`Upload failed: ${$.message}`);let m;if(t.options.calendarId){const{data:o}=await d.from("academic_calendar").select("deadline_date").eq("id",t.options.calendarId).single();o?.deadline_date&&(m=new Date(o.deadline_date))}else if(t.options.weekNumber){const{data:o}=await d.from("profiles").select("district_id").eq("id",t.options.userId).single();if(o?.district_id){const{data:f}=await d.from("academic_calendar").select("deadline_date").eq("district_id",o.district_id).eq("week_number",t.options.weekNumber).maybeSingle();f?.deadline_date&&(m=new Date(f.deadline_date))}}const h=new Date;let c="non-compliant";if(m){const o=new Date(m);if(o.setHours(23,59,59,999),h<=o)c="compliant";else{const f=new Date(o);f.setDate(f.getDate()+1),h<=f?c="late":c="non-compliant"}}else{const o=h.getDay();o===1||o===0?c="compliant":o===2?c="late":c="non-compliant"}const{error:_}=await d.from("submissions").insert({user_id:t.options.userId,file_name:t.fileName,file_path:t.filePath,file_hash:t.fileHash,file_size:t.fileSize,doc_type:t.options.docType||"Unknown",week_number:t.options.weekNumber,school_year:t.options.schoolYear||"2025-2026",subject:t.options.subject,calendar_id:t.options.calendarId||null,teaching_load_id:t.options.teachingLoadId||null,compliance_status:c});if(_)throw console.error("[pipeline] DB insert error:",_),new Error(`DB Insert failed: ${_.message}`);await k(r),await D(),s++,console.log(`[offline] Successfully synced: ${t.fileName}`)}catch(g){console.error(`[offline] Failed to sync ${t.fileName}:`,g),l++}}}finally{S=!1}return s>0&&y("success",`Synced ${s} file(s) successfully!`),l>0&&y("error",`Failed to sync ${l} file(s). Will retry automatically.`),{success:s,failed:l}}function j(){typeof window>"u"||(window.addEventListener("online",()=>{console.log('[offline] Network "online" event detected.'),y("info","Connection restored. Attempting verification..."),setTimeout(()=>{p()},3e3)}),setInterval(()=>{navigator.onLine&&p()},3e4),D(),navigator.onLine&&setTimeout(()=>{console.log("[offline] Initial load check..."),p()},5e3),document.addEventListener("visibilitychange",()=>{document.visibilityState==="visible"&&navigator.onLine&&p()}),window.addEventListener("focus",()=>{navigator.onLine&&p()}))}export{H as enqueue,F as getQueueSize,j as initOfflineSync,A as pendingSyncCount,p as processQueue,D as updatePendingCount};
